<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Train Graph API Visualizer</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    #cy { width: 100%; height: 600px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Train Graph API Visualizer</h1>
  <div id="cy"></div>

  <script>
    // Read query parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const start = urlParams.get('start') || 'frontend';
    const end = urlParams.get('end') || 'seat-service';
    const filters = urlParams.get('filters') || '';
    
    // Build API URL with query parameters
    let apiUrl = `/api/paths?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
    if (filters) {
      apiUrl += `&filters=${encodeURIComponent(filters)}`;
    }
    
    console.log('Fetching:', apiUrl);
    
    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: [
            ...data.nodes.map(n => {
              // Build comprehensive label with all properties
              let label = `${n.name}`;
              if (n.kind) label += `\nKind: ${n.kind}`;
              if (n.language) label += `\nLang: ${n.language}`;
              if (n.path) label += `\nPath: ${n.path.split('/').pop()}`; // Show just filename
              if (n.publicExposed !== undefined) label += `\nPublic: ${n.publicExposed ? 'Yes' : 'No'}`;
              if (n.vulnerabilities && n.vulnerabilities.length > 0) {
                label += `\nVulns: ${n.vulnerabilities.length}`;
              }
              if (n.metadata) {
                if (n.metadata.engine) label += `\nEngine: ${n.metadata.engine}`;
                if (n.metadata.version) label += `\nVer: ${n.metadata.version}`;
                if (n.metadata.cloud) label += `\nCloud: ${n.metadata.cloud}`;
              }
              
              // Determine node color based on properties
              let backgroundColor = '#FC6'; // Default orange
              if (n.publicExposed) backgroundColor = '#6CC'; // Light blue for public
              if (n.vulnerabilities && n.vulnerabilities.length > 0) backgroundColor = '#F66'; // Red for vulnerable
              if (n.kind === 'rds' || n.kind === 'database') backgroundColor = '#9F6'; // Green for databases
              
              return {
                data: { 
                  id: n.name, 
                  label: label,
                  // Store full node data for tooltips
                  fullData: n
                },
                style: {
                  'background-color': backgroundColor,
                  'shape': 'roundrectangle',
                  'width': 150,
                  'height': 80,
                  'label': label,
                  'color': '#000',
                  'text-valign': 'center',
                  'text-halign': 'center',
                  'font-size': '10px',
                  'text-wrap': 'wrap',
                  'text-max-width': 140,
                  'border-width': n.vulnerabilities && n.vulnerabilities.length > 0 ? '3px' : '1px',
                  'border-color': n.vulnerabilities && n.vulnerabilities.length > 0 ? '#C00' : '#888'
                }
              };
            }),
            ...data.edges.map(e => ({
              data: { source: e.from, target: e.to }
            }))
          ],
          style: [
            { selector: 'node', style: { 'label': 'data(label)', 'text-wrap': 'wrap', 'text-max-width': 140 } },
            { selector: 'edge', style: { 'curve-style': 'bezier', 'target-arrow-shape': 'triangle', 'line-color': '#888', 'target-arrow-color': '#888', 'width': 2 } }
          ],
          layout: { name: 'breadthfirst', directed: true, padding: 20 }
        });
      });
  </script>
</body>
</html>
